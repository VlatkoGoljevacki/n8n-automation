{
  "name": "[medika-preorders] WF-04: Data Validator",
  "active": false,
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        0,
        0
      ],
      "id": "f4000000-0000-4000-8000-000000000001",
      "name": "Sub-Workflow Input"
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "// Data validator — checks required fields and cross-references customer lookup\nconst input = $input.first().json;\nconst orderLines = input.orderLines || [];\nconst customer = input.customer || null;\nconst deliveryPlace = input.deliveryPlace || null;\nconst defaultDiscountPerc = input.defaultDiscountPerc || 0.0;\nconst lookup = input.customerLookup || { customerById: {}, deliveryPlaceById: {} };\n\nif (orderLines.length === 0) {\n  return [{\n    json: {\n      validated: true,\n      lineCount: 0,\n      summary: { valid: 0, invalid: 0, warnings: 0 },\n      validatedLines: [],\n      invalidLines: []\n    }\n  }];\n}\n\nconst validatedLines = [];\nconst invalidLines = [];\nlet warningCount = 0;\n\nfor (const line of orderLines) {\n  const errors = [];\n  const warnings = [];\n\n  // Required: articleId (Medika SKU)\n  const articleId = line.articleId || line.drugCode || null;\n  if (!articleId) {\n    errors.push('Missing article ID (Šifra proizvoda)');\n  }\n\n  // Required: quantity must be a positive number\n  const qty = parseFloat(line.quantity);\n  if (!qty || qty <= 0) {\n    errors.push('Invalid or missing quantity');\n  }\n\n  // Warning: articleName for ArticleDescCustomer\n  if (!line.articleName) {\n    warnings.push('Missing article name');\n  }\n\n  // Resolve customer + delivery place from line or sender mapping\n  const linePharmacyId = line.pharmacyId || null;\n  let resolvedCustomer = customer;\n  let resolvedDeliveryPlace = deliveryPlace;\n  let customerName = null;\n  let deliveryPlaceName = null;\n\n  // Try to match pharmacyId against delivery places in the lookup\n  if (linePharmacyId && lookup.deliveryPlaceById[linePharmacyId]) {\n    const dp = lookup.deliveryPlaceById[linePharmacyId];\n    resolvedCustomer = dp.customerId;\n    resolvedDeliveryPlace = linePharmacyId;\n    customerName = dp.customerName;\n    deliveryPlaceName = dp.name;\n  } else if (linePharmacyId && lookup.customerById[linePharmacyId]) {\n    // pharmacyId might actually be a customer ID\n    resolvedCustomer = linePharmacyId;\n    customerName = lookup.customerById[linePharmacyId].name;\n    // No specific delivery place — use first one if available\n  } else if (linePharmacyId) {\n    warnings.push('Pharmacy ID ' + linePharmacyId + ' not found in customer registry');\n  }\n\n  if (!resolvedCustomer) {\n    errors.push('Cannot determine Customer ID');\n  }\n\n  if (warnings.length > 0) warningCount++;\n\n  const validated = {\n    ...line,\n    articleId: articleId,\n    quantity: qty || 0,\n    customer: resolvedCustomer,\n    deliveryPlace: resolvedDeliveryPlace,\n    customerName: customerName,\n    deliveryPlaceName: deliveryPlaceName,\n    discountPerc: defaultDiscountPerc,\n    valid: errors.length === 0,\n    errors: errors,\n    warnings: warnings,\n    validatedAt: new Date().toISOString()\n  };\n\n  validatedLines.push(validated);\n  if (!validated.valid) {\n    invalidLines.push(validated);\n  }\n}\n\nreturn [{\n  json: {\n    validated: true,\n    lineCount: validatedLines.length,\n    summary: {\n      valid: validatedLines.length - invalidLines.length,\n      invalid: invalidLines.length,\n      warnings: warningCount\n    },\n    validatedLines: validatedLines,\n    invalidLines: invalidLines\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        0
      ],
      "id": "f4000000-0000-4000-8000-000000000002",
      "name": "Validate Required Fields"
    }
  ],
  "connections": {
    "Sub-Workflow Input": {
      "main": [
        [
          {
            "node": "Validate Required Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "tags": []
}
